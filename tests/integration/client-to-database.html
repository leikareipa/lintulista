<!DOCTYPE html>
<html>
    <head>
        <!-- Lintulista's root (assumes that this test is in "lintulista/tests/integration/").-->
        <base href="../../"/>

        <title>Lintulista! - Tests - Integration - Client-to-database</title>
        <meta name="viewport" content="width=device-width">
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
        <style>
            body
            {
                background-color: black;
                color: lightgray;
            }
        </style>
    </head>
    <body>
        <div id="header" style="line-height: 75%; padding-bottom: 10px;">
            <h2>Integration test: client-to-database</h2>
            Tests whether the client can successfully interact with the database.
        </div>

        <div id="results" style="margin: 20px;"></div>
        <div id="spinner" style="margin: 20px;"><i class="fas fa-spinner fa-spin"></i> Running tests</div>

        <script type="module">
            import {panic_if_not_type} from "./client/dist/assert.js";
            import {BackendAccess} from "./client/dist/backend-access.js";
            import {Observation} from "./client/dist/observation.js";
            import {Bird} from "./client/dist/bird.js";

            (async()=>
            {
                let backend = {};

                add_header("List");
                {
                    // Create a new list.
                    const keys = await BackendAccess.create_new_list();
                    (keys? success : fail)("Creating a new list.");

                    backend = await BackendAccess(keys.editKey);

                    // Verify keys.
                    ((backend.viewKey === keys.viewKey &&
                      backend.hasEditRights)? success : fail)("Keys are valid.");

                    // There should be no observations in a new list.
                    await backend.refresh_observation_cache();
                    (backend.observations().length? fail : success)("New list is empty.");
                }

                add_header("Observations");
                {
                    // Post an observation.
                    const bird = Bird({species: "Naakka", family: "", order: ""});
                    const observation = Observation({bird, date:new Date()});
                    (await backend.put_observation(observation)? success : fail)("Posting an observation client-side.");

                    // Verify that the observation was added server-side.
                    await backend.refresh_observation_cache();
                    ((backend.observations().length === 1 &&
                      backend.observations()[0].bird.species === "Naakka")? success : fail)("Posting an observation server-side.");

                    // Change an observation's date.
                    const modifiedObservation = Observation(
                    {
                        ...observation,
                        date: new Date(2000),
                    });
                    (await backend.put_observation(modifiedObservation)? success : fail)("Changing an observation's date client-side.")
                    await backend.refresh_observation_cache();
                    (backend.observations()[0].unixTimestamp === 2? success : fail)("Changing an observation's date server-side.");

                    // Delete an observation.
                    (await backend.delete_observation(modifiedObservation)? success : fail)("Deleting an observation client-side.");
                    
                    // Confirm that the observation was deleted server-side.
                    await backend.refresh_observation_cache();
                    (backend.observations().length? fail : success)("Deleting an observation server-side.");
                }

                finish();
            })();

            function success(testName = "")
            {
                add_result(testName, true);
            }

            function fail(testName)
            {
                add_result(testName, false);
            }

            function add_header(headerName)
            {
                panic_if_not_type("string", headerName);

                const container = document.createElement("div");
                const text = document.createTextNode(headerName);

                container.style.fontWeight = "bold";
                container.style.marginTop = "10px";

                container.appendChild(text);
                document.getElementById("results").appendChild(container);
            }

            function add_result(testName, succeeded)
            {
                panic_if_not_type("string", testName);
                panic_if_not_type("boolean", succeeded);

                const container = document.createElement("div");
                const text = document.createTextNode(testName);
                const icon = document.createElement("i");

                icon.className = `fas ${succeeded? "fa-check" : "fa-times"} fa-fw`;
                icon.style.marginRight = "7px";
                icon.style.color = `${succeeded? "" : "red"}`;
                
                container.appendChild(icon);
                container.appendChild(text);
                document.getElementById("results").appendChild(container);
            }

            function finish()
            {
                add_header("Tests finished!");
                document.getElementById("spinner").style.display = "none";
            }
        </script>
    </body>
</html>
